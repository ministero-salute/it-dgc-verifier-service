name: ministero-salute.it-dgc-verifier-service

trigger:
  branches:
    include:
    - master
    - develop
    - feature/*
    - releases/*
pr:
  branches:
    include:
    - master
    - develop
    - releases/*

pool:
  pool: Azure Pipelines

resources:
  containers:
  - container: mongo
    image: mongo
    ports:
    - 27017:27017

services:
  mongo: mongo

steps:
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    codeCoverageToolOption: 'JaCoCo'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.11'
    mavenVersionOption: 'Default'
    mavenAuthenticateFeed: false
    effectivePomSkip: false
    sonarQubeRunAnalysis: false

- task: BuildQualityChecks@8
  inputs:
    checkCoverage: true
    coverageFailOption: 'fixed'
    coverageType: 'lines'
    coverageThreshold: '80'
    
- task: SonarQubePrepare@4
  inputs:
    SonarQube: 'SonarQubeAzure-temp'
    scannerMode: 'CLI'
    configMode: 'manual'
    cliProjectKey: '$(System.TeamProject)_it-dgc-verifier-service'
    cliProjectName: '$(System.TeamProject)_it-dgc-verifier-service'
    cliSources: '.'
    extraProperties: |
      # Additional properties that will be passed to the scanner, 
      # Put one key=value per line, example:
      # sonar.exclusions=**/*.bin
      sonar.java.binaries=.
      sonar.exclusions=**/CCReport*/**
  condition: 
    and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

- task: SonarQubeAnalyze@4
  condition: 
    and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

- task: SonarQubePublish@4
  inputs:
    pollingTimeoutSec: '300'
  condition: 
    and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

- task: Docker@2
  inputs:
    command: 'build'
    Dockerfile: '**/Dockerfile'